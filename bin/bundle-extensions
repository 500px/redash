#!/usr/bin/env python
"""Copy bundle extension files to the client/app/extension directory"""
import os
from pathlib2 import Path
from shutil import copy

from redash import extensions

# Make a directory for extensions and set it as an environment variable
# to be picked up by webpack.
extensions_relative_path = Path('client', 'app', 'extensions')
extensions_directory = Path(__file__).parent.parent / extensions_relative_path

if not extensions_directory.exists():
    extensions_directory.mkdir()
os.environ["EXTENSIONS_DIRECTORY"] = str(extensions_relative_path)


bundles = extensions.bundles.items()
if bundles:
    print('Number of extension bundles found: {}'.format(len(bundles)))
else:
    print('No extension bundles found.')

for bundle_name, paths in bundles:
    # Shortcut in case not paths were found for the bundle
    if not paths:
        print('No paths found for bundle "{}".'.format(bundle_name))
        continue

    # The destination for the bundle files with the entry point name as the subdirectory
    destination = Path(extensions_directory, bundle_name)
    if not destination.exists():
        destination.mkdir()

    # Copy the bundle directory from the module to its destination.
    print('Copying "{}" bundle to {}:'.format(bundle_name, destination.resolve()))
    for src_path in paths:
        dest_path = destination / src_path.name
        print(" - {} -> {}".format(src_path, dest_path))
        copy(str(src_path), str(dest_path))
